// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

generator api_client {
  provider = "prisma-client-js"
  output   = "../api/node_modules/.prisma/client"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum FoodCategory {
  ENERGY_GEL
  ENERGY_BAR
  SPORTS_DRINK
  FRUIT
  SNACK
  OTHER
}

enum ConnectionStatus {
  PENDING
  DENIED
  ACCEPTED
}

enum SharedEventStatus {
  PENDING
  ACCEPTED
  DENIED
}

model User {
  id                      String            @id @default(uuid())
  auth0_sub               String            @unique
  email                   String?
  first_name              String
  last_name               String
  created_at              DateTime          @default(now())
  updated_at              DateTime          @updatedAt
  foodItems               FoodItem[]
  events                  Event[]
  eventGoalsBase          EventGoalsBase[]
  eventGoalsHourly        EventGoalsHourly[]
  initiatedConnections    UserConnection[]  @relation("InitiatingUser")
  receivedConnections     UserConnection[]  @relation("ReceivingUser")
  sharedEvents            SharedEvent[]     @relation("SenderUser")
  receivedEvents          SharedEvent[]     @relation("ReceiverUser")
}

model FoodItem {
  id                String             @id @default(uuid())
  item_name         String
  brand             String?
  category          FoodCategory?
  cost              Decimal?           @db.Decimal(10, 2)
  created_by        String
  created_at        DateTime           @default(now())
  updated_at        DateTime           @updatedAt
  user              User               @relation(fields: [created_by], references: [id])
  foodInstances     FoodInstance[]
  foodItemNutrients FoodItemNutrient[]
}

model Event {
  id                String             @id @default(uuid())
  event_user_id     String
  created_at        DateTime           @default(now())
  updated_at        DateTime           @updatedAt
  expected_duration Int
  type              String
  user              User               @relation(fields: [event_user_id], references: [id])
  foodInstances     FoodInstance[]
  eventGoalsBase    EventGoalsBase[]
  eventGoalsHourly  EventGoalsHourly[]
  sharedEvents      SharedEvent[]
}

model FoodInstance {
  id                         String   @id @default(uuid())
  time_elapsed_at_consumption Int
  created_at                 DateTime @default(now())
  updated_at                 DateTime @updatedAt
  food_item_id               String
  servings                   Int
  event_id                   String
  foodItem                   FoodItem @relation(fields: [food_item_id], references: [id])
  event                      Event    @relation(fields: [event_id], references: [id])
}

model Nutrient {
  id                   String               @id @default(uuid())
  created_at           DateTime             @default(now())
  updated_at           DateTime             @updatedAt
  nutrient_name        String
  nutrient_abbreviation String
  foodItemNutrients    FoodItemNutrient[]
  eventGoalsBase       EventGoalsBase[]
  eventGoalsHourly     EventGoalsHourly[]
}

model FoodItemNutrient {
  id           String   @id @default(uuid())
  food_item_id String
  nutrient_id  String
  quantity     Float
  unit         String
  foodItem     FoodItem @relation(fields: [food_item_id], references: [id])
  nutrient     Nutrient @relation(fields: [nutrient_id], references: [id])
}

model EventGoalsBase {
  id          String   @id @default(uuid())
  user_id     String
  event_id    String
  nutrient_id String
  quantity    Float
  unit        String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  event       Event    @relation(fields: [event_id], references: [id], onDelete: Cascade)
  nutrient    Nutrient @relation(fields: [nutrient_id], references: [id], onDelete: Cascade)

  @@unique([user_id, event_id, nutrient_id])
}

model EventGoalsHourly {
  id          String   @id @default(uuid())
  user_id     String
  event_id    String
  nutrient_id String
  hour        Int
  quantity    Float
  unit        String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  event       Event    @relation(fields: [event_id], references: [id], onDelete: Cascade)
  nutrient    Nutrient @relation(fields: [nutrient_id], references: [id], onDelete: Cascade)

  @@unique([user_id, event_id, nutrient_id, hour])
}

model UserConnection {
  id              String           @id @default(uuid())
  initiating_user String
  receiving_user  String
  status          ConnectionStatus @default(PENDING)
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt
  deleted_at      DateTime?
  initiator       User             @relation("InitiatingUser", fields: [initiating_user], references: [id], onDelete: Cascade)
  receiver        User             @relation("ReceivingUser", fields: [receiving_user], references: [id], onDelete: Cascade)

  @@unique([initiating_user, receiving_user])
}

model SharedEvent {
  id          String            @id @default(uuid())
  event_id    String
  sender_id   String
  receiver_id String
  status      SharedEventStatus @default(PENDING)
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt
  event       Event             @relation(fields: [event_id], references: [id], onDelete: Cascade)
  sender      User              @relation("SenderUser", fields: [sender_id], references: [id], onDelete: Cascade)
  receiver    User              @relation("ReceiverUser", fields: [receiver_id], references: [id], onDelete: Cascade)

  @@index([receiver_id])
  @@index([status])
}
